## Codex 协作流程（基于 PR 与堆叠分支机制）

这个流程的核心目标是：将每一个软件功能的开发生命周期，压缩进一个明确边界的 PR 分支中，使用 `.codex/` 结构文档作为 Codex agent 的语义输入通道，让 AI 成为可控、可审阅的异步开发参与者。整个开发不再以代码为起点，而以计划与任务文档为起点，以 PR 为轨道单元推进。

---

### 🧱 项目初始化

1. 在本地或远程仓库中创建项目目录，初始化 Git 仓库
2. 使用 macOS 项目结构（如 Xcode + SwiftUI）或 Web 项目（如 Vite + React）
3. 确定初始开发任务，例如 UI 布局、功能模块、数据模型等

---

### 🌿 创建堆叠分支

将功能拆解为小块堆叠推进的任务，每块功能使用一个单独分支，命名方式示例：

* `feat@register/01-ui`
* `feat@register/02-validate`
* `feat@register/03-api`

每个分支代表一个可控的功能单元。

---

### 🗂️ 初始化 `.codex/` 文档

每个分支中添加 `.codex/` 文件夹，包含如下文档：

* `plan.md`：高层目标、功能范围、排除范围
* `task.md`：具体开发任务细节（需要实现什么、在哪些文件、约束条件）
* `sketch.md`：结构草图、数据结构草图、UI 草图等
* `agent.md`：指明 Codex 的权限、职责、输出标准、可使用输入范围（选填）

这些文档作为 Codex 的语义输入基础，触发其行为执行。

---

### 🔁 提交并创建 PR

1. 将 `.codex/` 文档添加并提交
2. 在 GitHub 创建 Pull Request，对比主分支与当前分支
3. PR 命名使用语义型标题，如：`[PLAN] 注册 UI 页面初始布局`

一旦 PR 创建，Codex 将读取 diff、文档、上下文，进入任务执行模式。

---

### 🤖 Codex 行为机制

* 读取 `.codex/` 文档并构建任务上下文
* 解析 diff 与 PR 评论，判断应执行的行为
* 生成代码、组件、结构文件，并以 commit 形式提交到当前分支
* 回复评论或提示下一步行为建议

---

### 💬 人类审阅者交互方式

* 在 GitHub PR 中对代码行添加评论（例如建议重构、命名修改、提取逻辑）
* 使用约定前缀，如 `COD:` 表明是给 Codex 的行为指令
* 可手动编辑 `.codex/task.md` 或追加新的 `clarify.md` 表达需求

Codex 会监听这些输入并作为行为信号执行。

---

### ✅ Merge 或继续推进

* 当该分支任务完成，代码清晰且审阅通过，可合并 PR
* 若仍需新增行为，可继续添加 `.codex/task.md` 更新，Codex 会继续工作
* 若需堆叠新分支，继续 `git checkout -b feat@xxx/02-xxx` 并重复流程

---

### 📦 行为的最小单元是 PR

PR 是功能单元的生命周期窗口，是上下文挂载与行为生成的轨道单位。

每一个 PR，即是一次功能的编排、实施、审阅、收敛的闭环。

---

通过这个流程，Codex 不再是一个 AI 工具，而是一个结构任务代理；
PR 不再是审阅用的终点，而是协作起点；
文档不再是附属说明，而是行为的驱动规范。

最终形成的不是一堆代码，而是清晰可追踪的行为链条。
